name: Run the expreccs executable

on:
 push:
   branches:
     - main
 pull_request:
   
jobs:
  run-pyff-local:
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8']
        os: [ubuntu-latest]
        
    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install Flow Simulator
      run: |
        sudo apt-get update -y
        sudo apt-get install software-properties-common
        sudo apt-get install -y build-essential gfortran pkg-config cmake
        sudo apt-get install texlive-fonts-recommended texlive-fonts-extra dvipng cm-super
        sudo apt-get install -y libblas-dev libboost-all-dev libsuitesparse-dev libtrilinos-zoltan-dev

        CURRENT_DIRECTORY="$PWD"

        for module in common geometry grid istl
        do   git clone https://gitlab.dune-project.org/core/dune-$module.git --branch v2.9.0
        done
        for module in common geometry grid istl
        do   ./dune-common/bin/dunecontrol --only=dune-$module cmake -DCMAKE_DISABLE_FIND_PACKAGE_MPI=1
            ./dune-common/bin/dunecontrol --only=dune-$module make -j5
        done

        for repo in common grid models simulators
        do
            git clone https://github.com/OPM/opm-$repo.git
        done

        mkdir build

        for repo in common grid models
        do
            mkdir build/opm-$repo
            cd build/opm-$repo
            cmake -DUSE_MPI=0 -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$CURRENT_DIRECTORY/dune-common/build-cmake;$CURRENT_DIRECTORY/dune-grid/build-cmake;$CURRENT_DIRECTORY/dune-geometry/build-cmake;$CURRENT_DIRECTORY/dune-istl/build-cmake;$CURRENT_DIRECTORY/build/opm-common;$CURRENT_DIRECTORY/build/opm-grid" $CURRENT_DIRECTORY/opm-$repo
            make -j5
            cd ../..
        done    

        mkdir build/opm-simulators
        cd build/opm-simulators
        cmake -DUSE_MPI=0 -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="$CURRENT_DIRECTORY/dune-common/build-cmake;$CURRENT_DIRECTORY/dune-grid/build-cmake;$CURRENT_DIRECTORY/dune-geometry/build-cmake;$CURRENT_DIRECTORY/dune-istl/build-cmake;$CURRENT_DIRECTORY/build/opm-common;$CURRENT_DIRECTORY/build/opm-grid;$CURRENT_DIRECTORY/build/opm-models" $CURRENT_DIRECTORY/opm-simulators
        make -j5 flow_gasoil
        cd ../..
        
    - name: Install test dependecies
      run: |
        pip install --upgrade pip setuptools wheel
        pip install -r dev-requirements.txt
        pip install opm
        
    - name: Install expreccs
      run: |
        pip install .
        
    - name: Check code style and linting 
      run: |
        black --check src/ tests/ setup.py
        pylint src/ tests/ setup.py
        mypy --ignore-missing-imports src/ tests/ setup.py
      
    - name: Run the tests
      run: |
        pytest --cov=expreccs --cov-report term-missing tests/
        
    - name: Build documentation
      run: |
        pushd docs
        make html
